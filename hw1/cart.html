<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - BookStore</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .cart-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .cart-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            gap: 1rem;
        }
        .item-info {
            flex: 1;
            margin-left: 1rem;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .cart-footer {
            margin-top: 2rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            color: #666;
            cursor: pointer;
        }
        .empty-cart {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left-group">
            <div class="logo-section">
                <div class="logo"></div>
                <h1>BookStore</h1>
            </div>
            <div class="nav-menu">
                <button class="nav-link" onclick="location.href='index.html'">å…¨éƒ¨ä¹¦ç±</button>
                <button class="nav-link active" onclick="location.href='cart.html'">è´­ç‰©è½¦</button>
                <button class="nav-link" onclick="location.href='order.html'">æˆ‘çš„è®¢å•</button>
            </div>
        </div>
        <div class="user-section">
            <span>Hiï¼Œç”¨æˆ·</span>
        </div>
    </nav>

    <main class="cart-container">
        <h2>è´­ç‰©è½¦</h2>
        <div class="cart-items" id="cartItemsContainer">
            <!-- è´­ç‰©è½¦å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="cart-footer">
            <div class="footer-left">
                <label>
                    <input type="checkbox" id="selectAll"> å…¨é€‰
                </label>
            </div>
            <div class="footer-right">
                <span>æ€»è®¡ï¼š</span>
                <span class="total-price" id="totalPrice">Â¥0.00</span>
                <button class="btn btn-primary" id="checkoutBtn">å»ç»“ç®—</button>
            </div>
        </div>
    </main>

    <script src="assets/js/app.js"></script>
    <script>
        // è´­ç‰©è½¦é¡µé¢ä¸“ç”¨è„šæœ¬
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½è´­ç‰©è½¦æ•°æ®
            loadCartItems();
            
            // å…¨é€‰æŒ‰é’®äº‹ä»¶
            document.getElementById('selectAll').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.cart-item input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateTotalPrice();
            });
            
            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶ - ä¿®å¤äº‹ä»¶ç»‘å®šé—®é¢˜
            document.getElementById('cartItemsContainer').addEventListener('change', function(e) {
                if (e.target.classList.contains('item-checkbox')) {
                    updateTotalPrice();
                    updateSelectAllStatus();
                }
            });
            
            // ç»“ç®—æŒ‰é’®äº‹ä»¶
            document.getElementById('checkoutBtn').addEventListener('click', function() {
                const selectedItems = Array.from(document.querySelectorAll('.cart-item input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.closest('.cart-item').dataset.itemId);
                
                if (selectedItems.length === 0) {
                    showToast('è¯·é€‰æ‹©è¦ç»“ç®—çš„å•†å“', 'error');
                    return;
                }
                
                // åˆ›å»ºè®¢å•å¹¶è·³è½¬åˆ°è®¢å•é¡µ
                createOrder(selectedItems);
            });
        });
        
        // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
        function updateSelectAllStatus() {
            const allCheckboxes = document.querySelectorAll('.cart-item input[type="checkbox"]');
            const checkedBoxes = document.querySelectorAll('.cart-item input[type="checkbox"]:checked');
            
            if (allCheckboxes.length > 0) {
                document.getElementById('selectAll').checked = 
                    allCheckboxes.length === checkedBoxes.length;
            }
        }
        
        // åŠ è½½è´­ç‰©è½¦å•†å“
        function loadCartItems() {
            const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
            const container = document.getElementById('cartItemsContainer');
            
            if (cartItems.length === 0) {
                container.innerHTML = '<div class="empty-cart">è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå»<a href="index.html">ä¹¦åŸ</a>é€›é€›å§</div>';
                return;
            }
            
            container.innerHTML = cartItems.map(item => `
                <div class="cart-item" data-item-id="${item.id}">
                    <input type="checkbox" class="item-checkbox">
                    <img src="${item.cover}" alt="${item.title}" style="width: 80px">
                    <div class="item-info">
                        <h3><a href="book-detail.html?id=${item.id}">${item.title}</a></h3>
                        <p>ä½œè€…ï¼š${item.author}</p>
                        <p class="price-tag">Â¥${item.price.toFixed(2)}</p>
                    </div>
                    <div class="quantity-control">
                        <button class="quantity-minus" onclick="updateItemQuantity('${item.id}', -1)">-</button>
                        <span class="quantity">${item.quantity}</span>
                        <button class="quantity-plus" onclick="updateItemQuantity('${item.id}', 1)">+</button>
                    </div>
                    <span class="delete-btn" onclick="removeCartItem('${item.id}')">ğŸ—‘ï¸</span>
                </div>
            `).join('');
            
            // åˆå§‹åŒ–æ€»ä»·
            updateTotalPrice();
        }
        
        // æ›´æ–°å•†å“æ•°é‡
        function updateItemQuantity(itemId, change) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const itemIndex = cart.findIndex(item => item.id === itemId);
            
            if (itemIndex !== -1) {
                cart[itemIndex].quantity = Math.max(1, cart[itemIndex].quantity + change);
                localStorage.setItem('cart', JSON.stringify(cart));
                
                // æ›´æ–°æ˜¾ç¤ºçš„æ•°é‡
                const quantityElement = document.querySelector(`.cart-item[data-item-id="${itemId}"] .quantity`);
                if (quantityElement) {
                    quantityElement.textContent = cart[itemIndex].quantity;
                }
                
                updateTotalPrice();
            }
        }
        
        // ä»è´­ç‰©è½¦ç§»é™¤å•†å“
        function removeCartItem(itemId) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const newCart = cart.filter(item => item.id !== itemId);
            localStorage.setItem('cart', JSON.stringify(newCart));
            
            // ç§»é™¤DOMå…ƒç´ 
            document.querySelector(`.cart-item[data-item-id="${itemId}"]`).remove();
            
            // å¦‚æœè´­ç‰©è½¦ç©ºäº†ï¼Œæ˜¾ç¤ºç©ºè´­ç‰©è½¦ä¿¡æ¯
            if (newCart.length === 0) {
                document.getElementById('cartItemsContainer').innerHTML = 
                    '<div class="empty-cart">è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå»<a href="index.html">ä¹¦åŸ</a>é€›é€›å§</div>';
            }
            
            updateTotalPrice();
            updateSelectAllStatus();
            showToast('å·²ä»è´­ç‰©è½¦ç§»é™¤');
        }
        
        // è®¡ç®—æ€»ä»·
        function updateTotalPrice() {
            const selectedItems = Array.from(document.querySelectorAll('.cart-item input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.closest('.cart-item').dataset.itemId);
            
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const total = cart
                .filter(item => selectedItems.includes(item.id))
                .reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('totalPrice').textContent = `Â¥${total.toFixed(2)}`;
        }
        
        // åˆ›å»ºè®¢å•
        function createOrder(selectedItemIds) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const selectedItems = cart.filter(item => selectedItemIds.includes(item.id));
            
            if (selectedItems.length === 0) return;
            
            const orderTotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // åˆ›å»ºæ–°è®¢å•
            const newOrder = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                items: selectedItems,
                total: orderTotal,
                status: 'pending'
            };
            
            // ä¿å­˜åˆ°localStorage
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            // ä»è´­ç‰©è½¦ç§»é™¤å·²ç»“ç®—å•†å“
            const newCart = cart.filter(item => !selectedItemIds.includes(item.id));
            localStorage.setItem('cart', JSON.stringify(newCart));
            
            // è·³è½¬åˆ°è®¢å•é¡µé¢
            window.location.href = 'order.html';
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => toast.classList.add('show'), 10);
            
            // 2ç§’åæ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
